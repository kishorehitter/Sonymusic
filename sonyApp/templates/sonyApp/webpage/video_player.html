{% extends 'sonyApp/layouts/base.html' %}
{% load static %}

{% block title %}{{ current_video.title }} - {{ channel.name }}{% endblock title %}

{% block content %}
<div class="row g-0 min-vh-100">
    {% include 'sonyApp/inc/navbar.html' %}
    <div class="col-12 main-content ms-lg-auto px-0 mt-2 pt-5 overflow-hidden">
        
        <div class="container-fluid mx-0 mt-sm-1 mt-md-0 p-0">
            <div class="text-center m-0 p-0">
                
                {% if current_video.youtube_video_id and current_video.youtube_video_id|length == 11 %}
                    
                    <!-- ═══════════════════════════════════════
                         YOUTUBE VIDEO PLAYER
                    ═══════════════════════════════════════ -->
                    <div class="vp-wrapper {% if current_video.is_short %}is-short{% endif %}" id="vp-wrapper">
                        
                        <!-- YouTube iframe target -->
                        <div id="player" data-video-id="{{ current_video.youtube_video_id }}"></div>
                        
                        <!-- Black cover shown before first play -->
                        <div class="vp-cover" id="vp-cover"></div>
                        
                        <!-- Click shield (intercepts clicks on iframe) -->
                        <div class="vp-shield" id="vp-shield"></div>
                        
                        <!-- Double-tap zones - now visible on mobile -->
                        <div class="vp-tap-zones" id="vp-tap-zones">
                            <div class="vp-tap-left" id="vp-tap-left">
                                <div class="vp-tap-feedback">
                                    <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                                        <path d="M11.99 5V1l-5 5 5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6h-2c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
                                    </svg>
                                    <span>-10s</span>
                                </div>
                            </div>
                            <div class="vp-tap-right" id="vp-tap-right">
                                <div class="vp-tap-feedback">
                                    <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                                        <path d="M12.01 19V23l5-5-5-5v4c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6h2c0-4.42-3.58-8-8-8s-8 3.58-8 8 3.58 8 8 8z"/>
                                    </svg>
                                    <span>+10s</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Shorts Navigation Buttons - Always visible -->
                        {% if current_video.is_short %}
                        <div class="shorts-nav-buttons">
                            <button class="shorts-nav-btn prev" id="shorts-nav-prev" aria-label="Previous short">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                                </svg>
                            </button>
                            <button class="shorts-nav-btn next" id="shorts-nav-next" aria-label="Next short">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                </svg>
                            </button>
                        </div>
                        {% endif %}
                        
                        <!-- Big center play button -->
                        <div class="vp-big-play" id="vp-big-play">
                            <div class="vp-big-play-ring">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Spinner -->
                        <div class="vp-spinner" id="vp-spinner">
                            <div class="vp-spin-ring"></div>
                        </div>
                        
                        <!-- Error overlay -->
                        <div class="vp-error" id="vp-error">
                            <div class="vp-error-inner">
                                <div class="vp-err-circle">
                                    <div class="vp-err-bar"></div>
                                </div>
                                <h4>Can't play this video here</h4>
                                <p id="vp-error-msg">{{ channel.name }} has restricted embedding for this video.</p>
                                <a href="https://www.youtube.com/watch?v={{ current_video.youtube_video_id }}"
                                   target="_blank" rel="noopener" class="vp-error-btn">
                                    <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                                        <path d="M21.8 8s-.2-1.4-.8-2c-.8-.8-1.6-.8-2-.9C16.4 5 12 5 12 5s-4.4 0-7 .1c-.4.1-1.2.1-2 .9-.6.6-.8 2-.8 2S2 9.6 2 11.2v1.5c0 1.6.2 3.2.2 3.2s.2 1.4.8 2c.8.8 1.8.7 2.2.8C6.4 19 12 19 12 19s4.4 0 7-.2c.4-.1 1.2-.1 2-.9.6-.6.8-2 .8-2s.2-1.6.2-3.2v-1.5C22 9.6 21.8 8 21.8 8zM9.7 14.5V9l5.4 2.8-5.4 2.7z"/>
                                    </svg>
                                    Watch on YouTube
                                </a>
                            </div>
                        </div>
                        
                        <!-- Controls -->
                        <div class="vp-controls pb-0" id="vp-controls">
                            <div class="vp-prog-wrap" id="vp-prog-wrap">
                                <div class="vp-prog-bg">
                                    <div class="vp-prog-fill" id="vp-prog-fill"></div>
                                    <div class="vp-prog-thumb" id="vp-prog-thumb"></div>
                                </div>
                            </div>
                            
                            <div class="vp-ctrl-row pb-0 pb-md-1">
                                <button class="vp-btn" id="vp-playpause" aria-label="Play/Pause">
                                    <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                    <svg class="icon-pause" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                                </button>
                                
                                <span class="vp-time" id="vp-time">0:00 / 0:00</span>
                                
                                <div class="vp-vol-group" id="vp-vol-group">
                                    <button class="vp-btn" id="vp-mute" aria-label="Mute">
                                        <svg class="icon-vol-up" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                                        <svg class="icon-vol-mute" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                                    </button>
                                    <div class="vp-vol-slider" id="vp-vol-slider">
                                        <div class="vp-vol-track" id="vp-vol-track">
                                            <div class="vp-vol-fill" id="vp-vol-fill" style="width:100%"></div>
                                            <div class="vp-vol-thumb" id="vp-vol-thumb" style="left:100%"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="flex:1"></div>
                                
                                <!-- Quality menu - hidden on mobile -->
                                <div class="vp-quality-wrap d-none d-md-block" id="vp-quality-wrap">
                                    <button class="vp-btn vp-quality-btn" id="vp-quality-btn" aria-label="Quality">
                                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                                        <span id="vp-quality-label">Auto</span>
                                    </button>
                                    <div class="vp-quality-menu" id="vp-quality-menu">
                                        <div class="vp-q-opt" data-q="auto"><span>Auto</span><span class="vp-q-check" id="qc-auto">✓</span></div>
                                        <div class="vp-q-opt" data-q="low"><span>Low (240p)</span><span class="vp-q-check" id="qc-low">✓</span></div>
                                        <div class="vp-q-opt" data-q="med"><span>Med (480p)</span><span class="vp-q-check" id="qc-med">✓</span></div>
                                        <div class="vp-q-opt" data-q="high"><span>High (720p+)</span><span class="vp-q-check" id="qc-high">✓</span></div>
                                    </div>
                                </div>
                                
                                <!-- Fullscreen button - visible on mobile only for normal videos -->
                                <button class="vp-btn {% if current_video.is_short %}d-none{% else %}d-flex{% endif %} d-md-flex" id="vp-fs" aria-label="Fullscreen">
                                    <svg class="icon-fs-enter" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                                    <svg class="icon-fs-exit" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Custom End Screen -->
                        <div class="vp-end-screen" id="vp-end-screen">
                            <div class="vp-end-content">
                                <div class="vp-end-grid" id="vp-end-grid"></div>
                                <!-- Mobile navigation arrows -->
                                <div class="vp-mobile-nav" id="vp-mobile-nav">
                                    <button class="vp-nav-btn prev" id="vp-nav-prev" aria-label="Previous videos">
                                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                                    </button>
                                    <button class="vp-nav-btn next" id="vp-nav-next" aria-label="Next videos">
                                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                    </div><!-- /vp-wrapper -->
                    
                {% else %}
                    <div class="vp-wrapper d-flex align-items-center justify-content-center bg-dark">
                        <div class="text-center p-4">
                            <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
                            <h4 class="text-white">Video Unavailable</h4>
                            <p class="text-secondary">Invalid or missing YouTube video ID</p>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- Video Info -->
            <div class="container-fluid py-3">
                <div class="row">
                    <div class="col-12">
                        <div class="vp-info-card">
                            <h4 class="vp-info-title">{{ current_video.title }}</h4>
                            <div class="vp-info-meta">
                                <span>
                                    <svg viewBox="0 0 24 24" fill="currentColor" width="13" height="13"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/></svg>
                                    {{ channel.name }}
                                </span>
                                <span>
                                    <svg viewBox="0 0 24 24" fill="currentColor" width="13" height="13"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg>
                                    {{ current_video.published_at|date:"F d, Y" }}
                                </span>
                                {% if current_video.view_count %}
                                <span>
                                    <svg viewBox="0 0 24 24" fill="currentColor" width="13" height="13"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                                    {{ current_video.view_count|floatformat:0 }} views
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="vp-divider">
        
        <!-- Related Videos -->
        <div class="container-fluid px-0 mx-0 my-2">
            <div class="row mx-0 p-0">
                <h3 class="vp-section-title">More from {{ channel.name }}</h3>
                {% if streaming %}
                    {% for video in streaming %}
                    <div class="col-6 col-sm-4 col-md-3 col-lg-3 px-1 mb-3">
                        <div class="vid-card {% if video.youtube_video_id == current_video.youtube_video_id %}current-video{% endif %}" 
                             data-video-id="{{ video.youtube_video_id }}">
                            <a href="{% url 'video_player' channel.channel_id video.youtube_video_id %}" class="text-decoration-none">
                                <div class="vid-thumb-wrap">
                                    <img src="{{ video.thumbnail_url }}"
                                         alt="{{ video.title }}"
                                         class="vid-thumb"
                                         loading="lazy"
                                         onerror="this.src='{% static 'images/placeholder-video.jpg' %}'">
                                    <div class="vid-play-overlay">
                                        <svg viewBox="0 0 24 24" fill="white" width="28" height="28"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                    {% if video.duration %}
                                    <div class="vid-duration">{{ video.duration }}</div>
                                    {% endif %}
                                    {% if video.is_short %}
                                    <div class="vid-short-badge">Short</div>
                                    {% endif %}
                                    {% if video.youtube_video_id == current_video.youtube_video_id %}
                                    <div class="vid-current-badge">Now Playing</div>
                                    {% endif %}
                                </div>
                                <div class="vid-info">
                                    <p class="vid-title">{{ video.title|truncatechars:50 }}</p>
                                    <p class="vid-date">{{ video.published_at|date:"M d, Y" }}</p>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12 text-center py-4">
                        <p class="text-secondary">No other videos available.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        {% include 'sonyApp/inc/footer.html' %}
    </div>
</div>

<!-- Streaming data for JavaScript -->
<script id="streaming-data" type="application/json">
{{ streaming_json|safe }}
</script>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<style>
/* ============================================
   PLAYER WRAPPER - Base Styles
============================================ */
.vp-wrapper {
    position: relative;
    width: 100%;
    max-width: 1120px;
    aspect-ratio: 16 / 9;
    background: #000;
    margin: 0 auto;
    overflow: hidden;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
}

/* Shorts specific styles */
.vp-wrapper.is-short {
    aspect-ratio: 9 / 16;
    max-width: 500px;
    max-height: 90vh;
    margin: 0 auto;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

@media (min-width: 768px) {
    .vp-wrapper.is-short {
        max-height: 90vh;
    }
}

/* YouTube iframe */
.vp-wrapper iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

/* ============================================
   LAYER STACK
============================================ */
.vp-cover {
    position: absolute;
    inset: 0;
    background: #000;
    z-index: 2;
    transition: opacity .3s ease;
}

.vp-cover.hidden {
    opacity: 0;
    pointer-events: none;
}

.vp-shield {
    position: absolute;
    inset: 0;
    z-index: 3;
    cursor: pointer;
}

/* ============================================
   SHORTS NAVIGATION BUTTONS
============================================ */
.shorts-nav-buttons {
    position: absolute;
    bottom: 80px;
    left: 0;
    right: 0;
    z-index: 8;
    pointer-events: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 10px;
}

.shorts-nav-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    pointer-events: auto;
    transition: all 0.2s ease;
    -webkit-tap-highlight-color: transparent;
    padding: 0;
    opacity: 0.6;
    backdrop-filter: blur(4px);
}

.shorts-nav-btn:hover {
    opacity: 1;
    background: rgba(0, 0, 0, 0.7);
    transform: scale(1.1);
}

.shorts-nav-btn:active {
    transform: scale(0.95);
    opacity: 1;
    background: rgba(255, 255, 255, 0.3);
}

.shorts-nav-btn svg {
    width: 28px;
    height: 28px;
}

/* Always show buttons with opacity on mobile */
@media (max-width: 767px) {
     .shorts-nav-buttons {
        bottom: 80px; /* Higher on mobile to avoid controls */
        padding: 0 15px;
    }
    .shorts-nav-btn {
        opacity: 0.5;
        width: 44px;
        height: 44px;
        background: rgba(0, 0, 0, 0.4);
    }
    
    .shorts-nav-btn:active {
        opacity: 1;
        background: rgba(255, 255, 255, 0.3);
    }
}

/* ============================================
   TAP ZONES - For double-tap seeking
============================================ */
.vp-tap-zones {
    position: absolute;
    inset: 0;
    z-index: 3;
    pointer-events: none;
    display: flex;
}

.vp-tap-left, .vp-tap-right {
    flex: 1;
    pointer-events: all;
    position: relative;
    cursor: pointer;
}

.vp-tap-left {
    clip-path: inset(0 35% 0 0);
}

.vp-tap-right {
    clip-path: inset(0 0 0 35%);
}

.vp-tap-feedback {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: rgba(0, 0, 0, 0.7);
    border-radius: 50%;
    padding: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: white;
    font-size: 16px;
    font-weight: 600;
    pointer-events: none;
}

.vp-tap-left.active .vp-tap-feedback,
.vp-tap-right.active .vp-tap-feedback {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
}

/* ============================================
   BIG PLAY BUTTON
============================================ */
.vp-big-play {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 4;
    pointer-events: none;
    transition: opacity .25s ease;
}

.vp-big-play.hidden {
    opacity: 0;
}

.vp-big-play-ring {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: rgba(0,0,0,.55);
    border: 2px solid rgba(255,255,255,.7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    backdrop-filter: blur(4px);
}

.vp-big-play-ring svg {
    width: 32px;
    height: 32px;
    margin-left: 4px;
}

/* ============================================
   SPINNER
============================================ */
.vp-spinner {
    position: absolute;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 4;
    pointer-events: none;
}

.vp-spinner.show {
    display: flex;
}

.vp-spin-ring {
    width: 48px;
    height: 48px;
    border: 3px solid rgba(255,255,255,.15);
    border-top-color: #fff;
    border-radius: 50%;
    animation: vpSpin .75s linear infinite;
}

@keyframes vpSpin {
    to { transform: rotate(360deg); }
}

/* ============================================
   ERROR OVERLAY
============================================ */
.vp-error {
    position: absolute;
    inset: 0;
    background: #000;
    z-index: 5;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
}

.vp-error.show {
    display: flex;
}

.vp-error-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 14px;
    max-width: 420px;
}

.vp-err-circle {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,.55);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 4px;
}

.vp-err-bar {
    width: 2px;
    height: 22px;
    background: rgba(255,255,255,.55);
    border-radius: 2px;
}

.vp-error-inner h4 {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    margin: 0;
}

.vp-error-inner p {
    font-size: 13.5px;
    color: rgba(255,255,255,.55);
    margin: 0;
    line-height: 1.55;
}

.vp-error-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 11px 28px;
    background: #FF0000;
    color: #fff;
    border-radius: 28px;
    font-size: 14px;
    font-weight: 700;
    text-decoration: none;
    margin-top: 4px;
    transition: background .15s;
}

.vp-error-btn:hover {
    background: #cc0000;
}

/* ============================================
   CONTROLS
============================================ */
.vp-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 6;
    opacity: 0;
    transform: translateY(4px);
    transition: opacity .25s ease, transform .25s ease;
    pointer-events: none;
    background: linear-gradient(
        to top,
        rgba(0,0,0,.85) 0%,
        rgba(0,0,0,.5) 55%,
        transparent 100%
    );
    padding: 0px 12px 12px;
}

.vp-wrapper:hover .vp-controls,
.vp-controls.force-show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

/* Progress bar */
.vp-prog-wrap {
    width: 100%;
    padding: 8px 0 6px;
    cursor: pointer;
}

.vp-prog-bg {
    position: relative;
    height: 4px;
    background: rgba(255,255,255,.3);
    border-radius: 2px;
    overflow: visible;
    transition: height .15s ease;
}

.vp-prog-wrap:active .vp-prog-bg {
    height: 6px;
}

.vp-prog-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0%;
    background: white;
    border-radius: 2px;
    pointer-events: none;
}

.vp-prog-thumb {
    position: absolute;
    top: 50%;
    left: 0%;
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    opacity: 0;
    transition: opacity .15s ease;
}

.vp-prog-wrap:active .vp-prog-thumb {
    opacity: 1;
}

/* Control row */
.vp-ctrl-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 2px 8px;
}

/* Buttons */
.vp-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: #fff;
    width: 40px;
    height: 40px;
    border-radius: 4px;
    cursor: pointer;
    flex-shrink: 0;
    padding: 0;
    transition: background .15s;
    -webkit-tap-highlight-color: transparent;
}

.vp-btn:active {
    background: rgba(255,255,255,.2);
}

.vp-btn svg {
    width: 22px;
    height: 22px;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
}

/* Time */
.vp-time {
    font-size: 13px;
    font-family: 'Courier New', monospace;
    color: #fff;
    white-space: nowrap;
    padding: 0 6px;
    flex-shrink: 0;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

/* Volume */
.vp-vol-group {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
}

.vp-vol-slider {
    width: 0;
    overflow: hidden;
    transition: width .25s ease;
}

.vp-vol-group:hover .vp-vol-slider {
    width: 72px;
}

.vp-vol-track {
    position: relative;
    width: 72px;
    padding: 10px 0;
    cursor: pointer;
}

.vp-vol-fill {
    position: absolute;
    top: 50%;
    left: 0;
    height: 4px;
    background: #fff;
    border-radius: 2px;
    transform: translateY(-50%);
    pointer-events: none;
}

.vp-vol-thumb {
    position: absolute;
    top: 50%;
    width: 12px;
    height: 12px;
    background: #fff;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    opacity: 0;
}

.vp-vol-track:active .vp-vol-thumb {
    opacity: 1;
}

.vp-vol-track::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 5%;
    right: 0;
    height: 4px;
    background: rgba(255,255,255,.3);
    border-radius: 2px;
    transform: translateY(-50%);
}

/* Quality menu */
.vp-quality-wrap {
    position: relative;
    flex-shrink: 0;
}

.vp-quality-btn {
    width: auto;
    gap: 5px;
    padding: 0 10px;
}

.vp-quality-btn span {
    font-size: 12px;
    font-weight: 600;
    color: #fff;
}

.vp-quality-menu {
    display: none;
    position: absolute;
    bottom: 100%;
    right: 0;
    background: rgba(28, 28, 28, 0.98);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 8px;
    padding: 6px 0;
    min-width: 120px;
    box-shadow: 0 8px 24px rgba(0,0,0,.8);
    z-index: 20;
    margin-bottom: 8px;
}

.vp-quality-menu.show {
    display: block;
}

.vp-q-opt {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 16px;
    font-size: 13px;
    color: rgba(255,255,255,.8);
    cursor: pointer;
    transition: background .12s;
}

.vp-q-opt:active {
    background: rgba(255,255,255,.1);
    color: #fff;
}

.vp-q-check {
    color: #fff;
    opacity: 0;
    font-size: 13px;
}

.vp-q-check.active {
    opacity: 1;
}

/* ============================================
   END SCREEN
============================================ */
.vp-end-screen {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(10px);
    z-index: 10;
    display: none;
    overflow: hidden;
}

.vp-end-screen.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.vp-end-content {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    position: relative;
    padding: 20px;
}

.vp-end-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin: 0 auto;
}

.vp-end-video-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    border: 1px solid transparent;
    -webkit-tap-highlight-color: transparent;
}

.vp-end-video-card:active {
    transform: scale(0.98);
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
}

.vp-end-video-card img {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
    display: block;
    pointer-events: none;
}

.vp-end-video-title {
    color: white;
    padding: 12px;
    font-size: 13px;
    font-weight: 500;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Mobile navigation */
.vp-mobile-nav {
    display: none;
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    transform: translateY(-50%);
    justify-content: space-between;
    padding: 0 10px;
    pointer-events: none;
}

.vp-nav-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    pointer-events: auto;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
    padding: 0;
}

.vp-nav-btn:active {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(0.95);
}

.vp-nav-btn svg {
    width: 28px;
    height: 28px;
}

/* ============================================
   VIDEO INFO
============================================ */
.vp-info-card {
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.07);
    border-radius: 12px;
    padding: 18px 20px;
}

.vp-info-title {
    font-size: 17px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 10px;
    line-height: 1.35;
}

.vp-info-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    font-size: 12px;
    color: rgba(255,255,255,.4);
}

.vp-info-meta span {
    display: flex;
    align-items: center;
    gap: 5px;
}

.vp-divider {
    border-color: rgba(255,255,255,.07);
    margin: 0 0 16px;
}

.vp-section-title {
    text-align: center;
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 16px;
    font-family: serif;
    letter-spacing: .03em;
}

/* ============================================
   RELATED VIDEOS
============================================ */
.vid-card {
    transition: transform .25s ease;
    cursor: pointer;
}

.vid-card:active {
    transform: scale(0.98);
}

.vid-thumb-wrap {
    position: relative;
    aspect-ratio: 16 / 9;
    overflow: hidden;
    border-radius: 8px;
    background: #111;
}

.vid-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform .3s ease;
    pointer-events: none;
}

.vid-play-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.3);
    opacity: 0;
    transition: opacity .25s ease;
    pointer-events: none;
}

.vid-card:active .vid-play-overlay {
    opacity: 1;
}

.vid-duration {
    position: absolute;
    bottom: 6px;
    right: 6px;
    background: rgba(0,0,0,.8);
    color: #fff;
    font-size: 10px;
    font-weight: 600;
    padding: 2px 5px;
    border-radius: 4px;
}

.vid-short-badge {
    position: absolute;
    top: 5px;
    left: 5px;
    background: linear-gradient(135deg, #ff1744, #d50000);
    color: #fff;
    font-size: 9px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
}

.vid-current-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    font-size: 9px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.3);
}

.vid-info {
    padding: 6px 2px 0;
}

.vid-title {
    font-size: 12px;
    font-weight: 600;
    color: rgba(255,255,255,.85);
    margin: 0 0 3px;
    line-height: 1.35;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.vid-date {
    font-size: 10.5px;
    color: rgba(255,255,255,.3);
    margin: 0;
}

/* ============================================
   SHORTS SWIPE ANIMATION - Disabled
============================================ */
/* .vp-wrapper.swiping {
    transition: transform 0.3s ease;
}

.vp-wrapper.swipe-left {
    transform: translateX(-100%);
}

.vp-wrapper.swipe-right {
    transform: translateX(100%);
} */

/* Shorts fullscreen styles */
.vp-wrapper:fullscreen,
.vp-wrapper:-webkit-full-screen {
    background-color: #000;
}

.is-shorts .vp-wrapper:fullscreen {
    display: flex;
    align-items: center;
    justify-content: center;
}

.is-shorts .vp-wrapper:fullscreen iframe {
    height: 100vh;
    width: auto;
    max-width: 100vw;
}

/* ============================================
   MEDIA QUERIES - All grouped at bottom
============================================ */

/* Mobile styles (max-width: 767px) */
@media (max-width: 767px) {
    /* Fix overflow */
    body {
        overflow-x: hidden;
        overflow-y: auto;
    }
    
    .main-content {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Player wrapper */
    .vp-wrapper {
        width: 100%;
        margin-left: 0;
        margin-right: 0;
        max-width: 100%;
    }
    
    /* Shorts specific mobile */
    .vp-wrapper.is-short {
        max-height: 85vh;
        border-radius: 0;
    }
    
    /* Allow page scrolling */
    .container-fluid {
        overflow-y: visible;
    }
    
    /* Big play button */
    .vp-big-play-ring {
        width: 56px;
        height: 56px;
    }
    
    .vp-big-play-ring svg {
        width: 24px;
        height: 24px;
    }
    
    /* Show double-tap zones on mobile */
    .vp-tap-zones {
        display: flex !important;
    }
    
    /* Make shield clickable for play/pause */
    .vp-shield {
        pointer-events: all;
    }
    
    /* Show all controls on mobile */
    .vp-vol-group {
        display: flex !important;
    }
    
    /* Hide quality menu on mobile for all videos */
    .vp-quality-wrap {
        display: none !important;
    }
    
    /* Show fullscreen button only for normal videos on mobile */
    .vp-wrapper:not(.is-short) #vp-fs {
        display: flex !important;
    }
    
    /* Hide fullscreen button for shorts on mobile */
    .vp-wrapper.is-short #vp-fs {
        display: none !important;
    }
    
    /* Adjust volume slider for mobile */
    .vp-vol-group:hover .vp-vol-slider {
        width: 60px;
    }
    
    .vp-vol-track {
        width: 60px;
    }
    
    /* Make buttons bigger on mobile */
    .vp-btn {
        width: 44px;
        height: 44px;
    }
    
    .vp-btn svg {
        width: 24px;
        height: 24px;
    }
    
    /* Mobile end screen with horizontal scroll */
    .vp-end-screen {
        overflow: hidden;
    }
    
    .vp-end-content {
        padding: 16px 0;
        position: relative;
        overflow: visible;
    }
    
    .vp-end-grid {
        display: flex;
        flex-direction: row;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-snap-type: x mandatory;
        gap: 12px;
        padding: 0 16px 20px;
        margin: 0;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .vp-end-grid::-webkit-scrollbar {
        display: none;
    }
    
    .vp-end-video-card {
        flex: 0 0 100vw;
        max-width: 100vw;
        scroll-snap-align: start;
        margin-right: 0;
    }
    
    /* Show mobile navigation */
    .vp-mobile-nav {
        display: flex;
    }
    
    /* Adjust controls padding */
    .vp-controls {
        padding: 0 8px 8px;
    }
    
    .vp-ctrl-row {
        gap: 0px;
    }
    
    .vp-time {
        font-size: 12px;
    }
    
    /* Fullscreen orientation handling */
    .vp-wrapper:fullscreen,
    .vp-wrapper:-webkit-full-screen {
        width: 100vw !important;
        height: 100vh !important;
        max-width: 100vw !important;
        margin: 0 !important;
        aspect-ratio: auto !important;
    }
    
    .vp-wrapper:fullscreen iframe,
    .vp-wrapper:-webkit-full-screen iframe {
        width: 100vw !important;
        height: 100vh !important;
        object-fit: contain;
    }
    
    /* Force landscape orientation hint */
    @media (orientation: portrait) {
        .vp-wrapper:fullscreen::after {
            content: "Please rotate your device for better viewing";
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-size: 14px;
            z-index: 100;
        }
    }
}

/* Tablet styles (768px to 991px) */
@media (min-width: 768px) and (max-width: 991px) {
    .vp-end-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
}

/* Fullscreen base styles (applies to all screens) */
.vp-wrapper:fullscreen .vp-controls {
    padding: 0px 20px 20px;
}

.vp-wrapper:fullscreen .vp-btn svg {
    width: 28px;
    height: 28px;
}
</style>

{% endblock content %}

{% block scripts %}
{{ block.super }}
<script>
(function () {
'use strict';

/* Load YouTube API */
var tag = document.createElement('script');
tag.src = 'https://www.youtube.com/iframe_api';
document.head.appendChild(tag);

/* State */
var player = null;
var ready = false;
var muted = false;
var vol = 1;
var progDrag = false;
var activityTimer = null;
var progressTimer = null;
var streamingVideos = [];
var unembeddableVideos = [];
var isEmbedError = false;
var controlsVisible = false;
var isMobile = window.innerWidth <= 767;
var userInteracted = false;
var isShort = {{ current_video.is_short|yesno:"true,false" }};
var lastTap = null;
var lastTapTime = 0;
var currentChannelId = '{{ channel.channel_id }}';
var currentVideoId = '{{ current_video.youtube_video_id }}';

// Swipe state for shorts
var touchStartX = 0;
var touchStartY = 0;
var touchEndX = 0;
var touchEndY = 0;
var minSwipeDistance = 50;
var isSwiping = false;

/* DOM shortcuts */
function $$(id) { return document.getElementById(id); }
var wrapper = $$('vp-wrapper');
var cover = $$('vp-cover');
var shield = $$('vp-shield');
var bigPlay = $$('vp-big-play');
var spinner = $$('vp-spinner');
var errorEl = $$('vp-error');
var controls = $$('vp-controls');
var progFill = $$('vp-prog-fill');
var progThumb = $$('vp-prog-thumb');
var progWrap = $$('vp-prog-wrap');
var timeEl = $$('vp-time');
var volFill = $$('vp-vol-fill');
var volThumb = $$('vp-vol-thumb');
var volTrack = $$('vp-vol-track');
var ppBtn = $$('vp-playpause');
var muteBtn = $$('vp-mute');
var fsBtn = $$('vp-fs');
var endScreen = $$('vp-end-screen');
var endGrid = $$('vp-end-grid');
var navPrev = $$('vp-nav-prev');
var navNext = $$('vp-nav-next');
var tapLeft = $$('vp-tap-left');
var tapRight = $$('vp-tap-right');
var shortsPrev = $$('shorts-nav-prev');
var shortsNext = $$('shorts-nav-next');

/* ============================================
   HELPER FUNCTIONS
============================================ */
function showBigPlay() { if (bigPlay) bigPlay.classList.remove('hidden'); }
function hideBigPlay() { if (bigPlay) bigPlay.classList.add('hidden'); }
function showSpinner() { if (spinner) spinner.classList.add('show'); }
function hideSpinner() { if (spinner) spinner.classList.remove('show'); }

function setPP(playing) {
    if (!ppBtn) return;
    var playIcon = ppBtn.querySelector('.icon-play');
    var pauseIcon = ppBtn.querySelector('.icon-pause');
    if (playIcon) playIcon.style.display = playing ? 'none' : '';
    if (pauseIcon) pauseIcon.style.display = playing ? '' : 'none';
}

function fmt(s) {
    s = Math.floor(s || 0);
    var m = Math.floor(s / 60);
    var sec = s % 60;
    return m + ':' + (sec < 10 ? '0' : '') + sec;
}

function togglePlay(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    if (!ready || !player || isEmbedError) return;
    
    var state = player.getPlayerState();
    if (state === YT.PlayerState.PLAYING) {
        player.pauseVideo();
    } else {
        hideBigPlay();
        showSpinner();
        player.playVideo();
    }
}

/* ============================================
   SCROLL TO PLAYER
============================================ */
function scrollToPlayer() {
    if (wrapper) {
        wrapper.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
}

/* ============================================
   SHORTS NAVIGATION
============================================ */
function navigateShort(direction) {
    var shorts = streamingVideos.filter(v => v.is_short);
    if (shorts.length === 0) return;
    
    var currentIndex = shorts.findIndex(v => v.youtube_video_id === currentVideoId);
    
    var newIndex;
    if (direction === 'next') {
        newIndex = (currentIndex + 1) % shorts.length;
    } else {
        newIndex = (currentIndex - 1 + shorts.length) % shorts.length;
    }
    
    if (newIndex !== currentIndex) {
        var nextVideo = shorts[newIndex];
        loadVideo(nextVideo.youtube_video_id);
    }
}

// Function to load video without page reload
function loadVideo(videoId) {
    if (!player || !ready) return;
    
    // Show black cover and spinner immediately
    if (cover) cover.classList.remove('hidden');
    hideBigPlay();
    showSpinner();
    hideEndScreen();
    
    // Update current video ID
    currentVideoId = videoId;
    
    // Update the player's video
    player.loadVideoById(videoId);
    
    // Update the URL without reloading the page
    var newUrl = '/channel/' + currentChannelId + '/video/' + videoId + '/';
    history.pushState({videoId: videoId}, '', newUrl);
    
    // Update video info section
    updateVideoInfo(videoId);
    
    // Scroll to player
    scrollToPlayer();
    
    // Update current video badge in related videos
    updateCurrentVideoBadge(videoId);
}

// Function to update current video badge
function updateCurrentVideoBadge(videoId) {
    // Remove current-video class from all cards
    document.querySelectorAll('.vid-card').forEach(function(card) {
        card.classList.remove('current-video');
        var badge = card.querySelector('.vid-current-badge');
        if (badge) badge.remove();
    });
    
    // Add current-video class to the new current video
    var currentCard = document.querySelector('.vid-card[data-video-id="' + videoId + '"]');
    if (currentCard) {
        currentCard.classList.add('current-video');
        var thumbWrap = currentCard.querySelector('.vid-thumb-wrap');
        if (thumbWrap && !thumbWrap.querySelector('.vid-current-badge')) {
            var badge = document.createElement('div');
            badge.className = 'vid-current-badge';
            badge.textContent = 'Now Playing';
            thumbWrap.appendChild(badge);
        }
    }
}

// Function to update video info
function updateVideoInfo(videoId) {
    var video = streamingVideos.find(v => v.youtube_video_id === videoId);
    if (!video) return;
    
    // Update title
    var titleEl = document.querySelector('.vp-info-title');
    if (titleEl) titleEl.textContent = video.title;
    
    // Update date
    var dateEl = document.querySelector('.vp-info-meta span:nth-child(2)');
    if (dateEl) {
        var date = new Date(video.published_at);
        var formattedDate = date.toLocaleDateString('en-US', { 
            month: 'long', 
            day: 'numeric', 
            year: 'numeric' 
        });
        dateEl.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="13" height="13"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg> ' + formattedDate;
    }
    
    // Update view count if exists
    var viewEl = document.querySelector('.vp-info-meta span:nth-child(3)');
    if (viewEl && video.view_count) {
        viewEl.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="13" height="13"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> ' + video.view_count + ' views';
    }
}

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    if (event.state && event.state.videoId) {
        loadVideo(event.state.videoId);
    }
});

// Add event listeners for shorts navigation buttons
if (shortsPrev) {
    shortsPrev.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        navigateShort('prev');
    });
}

if (shortsNext) {
    shortsNext.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        navigateShort('next');
    });
}

/* ============================================
   DOUBLE TAP SEEKING
============================================ */
function handleDoubleTap(direction) {
    if (!ready || !player) return;
    
    var currentTime = player.getCurrentTime();
    var duration = player.getDuration();
    var newTime;
    
    if (direction === 'left') {
        newTime = Math.max(0, currentTime - 10);
        if (tapLeft) {
            tapLeft.classList.add('active');
            setTimeout(function() {
                tapLeft.classList.remove('active');
            }, 300);
        }
    } else {
        newTime = Math.min(duration, currentTime + 10);
        if (tapRight) {
            tapRight.classList.add('active');
            setTimeout(function() {
                tapRight.classList.remove('active');
            }, 300);
        }
    }
    
    player.seekTo(newTime, true);
    resetActivityTimer();
}

// Double tap detection
if (tapLeft) {
    var leftTapCount = 0;
    var leftTapTimer = null;
    
    tapLeft.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        leftTapCount++;
        
        if (leftTapCount === 1) {
            leftTapTimer = setTimeout(function() {
                // Single tap - play/pause
                togglePlay(e);
                leftTapCount = 0;
            }, 250);
        } else if (leftTapCount === 2) {
            clearTimeout(leftTapTimer);
            // Double tap - seek left
            handleDoubleTap('left');
            leftTapCount = 0;
        }
    });
}

if (tapRight) {
    var rightTapCount = 0;
    var rightTapTimer = null;
    
    tapRight.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        rightTapCount++;
        
        if (rightTapCount === 1) {
            rightTapTimer = setTimeout(function() {
                // Single tap - play/pause
                togglePlay(e);
                rightTapCount = 0;
            }, 250);
        } else if (rightTapCount === 2) {
            clearTimeout(rightTapTimer);
            // Double tap - seek right
            handleDoubleTap('right');
            rightTapCount = 0;
        }
    });
}

/* ============================================
   CONTROLS VISIBILITY
============================================ */

function showControls(force = false) {
    if (!controls || isEmbedError) return;
    
    controls.classList.add('force-show');
    controls.style.opacity = '1';
    controls.style.pointerEvents = 'auto';
    controlsVisible = true;
    
    if (activityTimer) {
        clearTimeout(activityTimer);
        activityTimer = null;
    }
    
    if (force) return;
    
    var timeout = isMobile ? 3000 : 2000;
    activityTimer = setTimeout(function() {
        hideControls();
    }, timeout);
}

function hideControls() {
    if (!controls) return;
    controls.classList.remove('force-show');
    controls.style.opacity = '0';
    controls.style.pointerEvents = 'none';
    controlsVisible = false;
    
    if (activityTimer) {
        clearTimeout(activityTimer);
        activityTimer = null;
    }
}

function resetActivityTimer() {
    if (!controls || isEmbedError) return;
    showControls();
}

// Desktop hover events
if (wrapper && !isMobile) {
    wrapper.addEventListener('mousemove', function() {
        if (ready && player) {
            showControls();
        }
    });
    
    wrapper.addEventListener('mouseleave', function() {
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
            hideControls();
        }
    });
}

// Mobile touch events
if (wrapper && isMobile) {
    wrapper.addEventListener('touchstart', function(e) {
        if (e.target.closest('.vp-controls') || e.target.closest('.shorts-nav-btn')) {
            return;
        }
        
        if (controlsVisible) {
            hideControls();
        } else {
            showControls(true);
            resetActivityTimer();
        }
    }, { passive: true });
}

// Keep controls visible when interacting with them
if (controls) {
    controls.addEventListener('mouseenter', function() {
        if (activityTimer) {
            clearTimeout(activityTimer);
            activityTimer = null;
        }
    });
    
    controls.addEventListener('mouseleave', function() {
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
            resetActivityTimer();
        }
    });
    
    controls.addEventListener('touchstart', function(e) {
        e.stopPropagation();
        if (activityTimer) {
            clearTimeout(activityTimer);
            activityTimer = null;
        }
    }, { passive: true });
}

/* ============================================
   YOUTUBE API
============================================ */
window.onYouTubeIframeAPIReady = function () {
    var el = $$('player');
    if (!el) return;
    var vid = el.getAttribute('data-video-id');
    if (!vid || vid.length !== 11) return;

    // Hide play button and show spinner immediately
    hideBigPlay();
    showSpinner();

    player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: vid,
        playerVars: {
            autoplay: 1,
            controls: 0,
            modestbranding: 1,
            rel: 0,
            iv_load_policy: 3,
            enablejsapi: 1,
            disablekb: 1,
            fs: 0,
            playsinline: 1,
            cc_load_policy: 0
        },
        events: {
            onReady: onReady,
            onStateChange: onStateChange,
            onError: onError
        }
    });
};

function onReady(e) {
    ready = true;
    
    // Keep spinner visible, hide play button
    hideBigPlay();
    showSpinner();
    
    var dur = player.getDuration();
    if (timeEl) timeEl.textContent = '0:00 / ' + fmt(dur);
    initVolSlider();
    initProgressBar();
    
    // Auto-play immediately
    try {
        if (player.getDuration() > 0) {
            player.playVideo();
        }
    } catch (e) {}
}

function onStateChange(e) {
    var S = YT.PlayerState;

    if (e.data === S.PLAYING) {
        if (cover) cover.classList.add('hidden');
        hideBigPlay();
        hideSpinner();
        setPP(true);
        startProgress();
        hideEndScreen();
        isEmbedError = false;
        
        setTimeout(function() {
            if (player && player.getPlayerState() === S.PLAYING && !userInteracted) {
                hideControls();
            }
        }, 2000);

    } else if (e.data === S.PAUSED) {
        if (!isEmbedError) {
            showBigPlay();
        }
        hideSpinner();
        setPP(false);
        stopProgress();
        showControls(true);

    } else if (e.data === S.ENDED) {
        showBigPlay();
        hideSpinner();
        setPP(false);
        stopProgress();
        showControls(true);
        showEndScreen();

    } else if (e.data === S.BUFFERING) {
        if (!isEmbedError) {
            hideBigPlay();
            showSpinner();
        }
    } else if (e.data === S.CUED) {
        hideBigPlay();
        showSpinner();
    }
}

function onError(e) {
    hideSpinner();
    hideBigPlay();
    console.log('Player error:', e.data);

    if (e.data === 101 || e.data === 150) {
        isEmbedError = true;
        autoSkipToNext();
    } else {
        var msgEl = $$('vp-error-msg');
        if (msgEl) {
            msgEl.textContent = e.data === 100 ? 'Video unavailable' : 'Cannot play video';
        }
        if (errorEl) errorEl.classList.add('show');
    }
}

/* ============================================
   MOBILE LAYOUT & SHORTS SWIPE
============================================ */

// Set player aspect ratio based on content type
if (isShort && wrapper) {
    wrapper.classList.add('is-short');
}

// Swipe detection is disabled - using buttons only

/* ============================================
   PROGRESS BAR
============================================ */
function initProgressBar() {
    if (!progWrap) return;
    
    progWrap.addEventListener('mousedown', startSeek);
    progWrap.addEventListener('touchstart', startSeek, { passive: false });
    progWrap.addEventListener('click', seek);
    
    document.addEventListener('mousemove', function(e) {
        if (progDrag) seek(e);
    });
    
    document.addEventListener('touchmove', function(e) {
        if (progDrag) {
            e.preventDefault();
            seek(e.touches[0]);
        }
    }, { passive: false });
    
    document.addEventListener('mouseup', endSeek);
    document.addEventListener('touchend', endSeek);
}

function startSeek(e) {
    progDrag = true;
    seek(e);
}

function endSeek() {
    progDrag = false;
    resetActivityTimer();
}

function seek(e) {
    if (!ready || !player) return;
    e.preventDefault();
    e.stopPropagation();
    
    var clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
    var rect = progWrap.getBoundingClientRect();
    var pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
    var t = player.getDuration() * pct;
    
    player.seekTo(t, true);
    setProgUI(pct);
    if (timeEl) {
        timeEl.textContent = fmt(t) + ' / ' + fmt(player.getDuration());
    }
}

function startProgress() {
    stopProgress();
    progressTimer = setInterval(function() {
        if (!ready || !player || progDrag) return;
        try {
            var t = player.getCurrentTime();
            var dur = player.getDuration();
            var pct = dur ? t / dur : 0;
            setProgUI(pct);
            if (timeEl) timeEl.textContent = fmt(t) + ' / ' + fmt(dur);
        } catch (e) {}
    }, 200);
}

function stopProgress() {
    if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
    }
}

function setProgUI(pct) {
    var p = (pct * 100).toFixed(2) + '%';
    if (progFill) progFill.style.width = p;
    if (progThumb) progThumb.style.left = p;
}

/* ============================================
   VOLUME
============================================ */
function initVolSlider() {
    if (!volTrack) return;
    
    volTrack.addEventListener('click', applyVol);
    volTrack.addEventListener('touchstart', function(e) {
        e.preventDefault();
        applyVol(e);
    }, { passive: false });
}

function applyVol(e) {
    if (!ready || !player) return;
    var rect = volTrack.getBoundingClientRect();
    var clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
    var v = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
    vol = v;
    muted = (v === 0);
    player.setVolume(v * 100);
    updateVolUI(v);
    resetActivityTimer();
}

function updateVolUI(v) {
    var p = (v * 100).toFixed(1) + '%';
    if (volFill) volFill.style.width = p;
    if (volThumb) volThumb.style.left = p;
    if (!muteBtn) return;
    var upIcon = muteBtn.querySelector('.icon-vol-up');
    var muteIcon = muteBtn.querySelector('.icon-vol-mute');
    if (upIcon) upIcon.style.display = (v > 0) ? '' : 'none';
    if (muteIcon) muteIcon.style.display = (v > 0) ? 'none' : '';
}

// Mute button
if (muteBtn) {
    muteBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!ready || !player) return;
        
        if (muted || vol === 0) {
            vol = 0.7;
            player.setVolume(70);
            muted = false;
        } else {
            muted = true;
            player.setVolume(0);
        }
        updateVolUI(muted ? 0 : vol);
        resetActivityTimer();
    });
}

// Play/pause button
if (ppBtn) {
    ppBtn.addEventListener('click', function(e) {
        togglePlay(e);
        resetActivityTimer();
    });
}

// Shield click handler
if (shield) {
    shield.addEventListener('click', function(e) {
        togglePlay(e);
        resetActivityTimer();
    });
}

/* ============================================
   FULLSCREEN HANDLING
============================================ */
// Handle fullscreen change events
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('mozfullscreenchange', handleFullscreenChange);
document.addEventListener('MSFullscreenChange', handleFullscreenChange);

function handleFullscreenChange() {
    if (document.fullscreenElement || document.webkitFullscreenElement) {
        // Entered fullscreen
        if (screen.orientation && screen.orientation.lock) {
            // Try to lock to landscape
            screen.orientation.lock('landscape').catch(function(e) {
                console.log('Orientation lock not supported');
            });
        }
    } else {
        // Exited fullscreen
        if (screen.orientation && screen.orientation.unlock) {
            screen.orientation.unlock();
        }
    }
}

// Fullscreen button
if (fsBtn) {
    fsBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var w = $$('vp-wrapper');
        if (!w) return;
        
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
            if (w.requestFullscreen) {
                w.requestFullscreen();
            } else if (w.webkitRequestFullscreen) {
                w.webkitRequestFullscreen();
            } else if (w.msRequestFullscreen) {
                w.msRequestFullscreen();
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }
        resetActivityTimer();
    });
}

/* ============================================
   AUTO SKIP TO NEXT
============================================ */
function autoSkipToNext() {
    var availableVideos = streamingVideos.filter(function(video) {
        return !unembeddableVideos.includes(video.youtube_video_id);
    });
    
    if (availableVideos.length === 0) {
        if (errorEl) errorEl.classList.add('show');
        return;
    }

    if (cover) cover.classList.remove('hidden');
    hideBigPlay();
    showSpinner();
    
    if (errorEl) errorEl.classList.remove('show');
    
    setTimeout(function() {
        var next = availableVideos[0];
        loadVideo(next.youtube_video_id);
    }, 2000);
}

/* ============================================
   END SCREEN
============================================ */
function showEndScreen() {
    if (!endScreen || !endGrid || !streamingVideos.length) return;
    
    var availableVideos = streamingVideos.filter(v => !unembeddableVideos.includes(v.youtube_video_id));
    if (!availableVideos.length) return;
    
    endGrid.innerHTML = '';
    
    availableVideos.slice(0, 6).forEach(function(video) {
        var card = document.createElement('div');
        card.className = 'vp-end-video-card';
        card.setAttribute('data-video-id', video.youtube_video_id);
        card.innerHTML = 
            '<img src="' + video.thumbnail_url + '" loading="lazy">' +
            '<div class="vp-end-video-title">' + video.title + '</div>';
        
        card.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            loadVideo(video.youtube_video_id);
        });
        
        card.style.cursor = 'pointer';
        
        endGrid.appendChild(card);
    });
    
    endScreen.classList.add('show');
    showControls(true);
}

function hideEndScreen() {
    if (endScreen) endScreen.classList.remove('show');
}

// Mobile navigation for end screen
if (navPrev && navNext) {
    navPrev.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (!endGrid) return;
        
        var cardWidth = endGrid.querySelector('.vp-end-video-card')?.offsetWidth + 12 || 0;
        if (cardWidth > 0) {
            var currentIndex = Math.floor(endGrid.scrollLeft / cardWidth);
            var newIndex = Math.max(0, currentIndex - 1);
            endGrid.scrollTo({
                left: newIndex * cardWidth,
                behavior: 'smooth'
            });
        }
    });
    
    navNext.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (!endGrid) return;
        
        var cardWidth = endGrid.querySelector('.vp-end-video-card')?.offsetWidth + 12 || 0;
        if (cardWidth > 0) {
            var currentIndex = Math.floor(endGrid.scrollLeft / cardWidth);
            var maxIndex = endGrid.children.length - 1;
            var newIndex = Math.min(maxIndex, currentIndex + 1);
            endGrid.scrollTo({
                left: newIndex * cardWidth,
                behavior: 'smooth'
            });
        }
    });
}

/* ============================================
   HELPERS
============================================ */
function getCsrf() {
    var el = document.querySelector('[name=csrfmiddlewaretoken]');
    return el ? el.value : '';
}

function loadStreamingData() {
    var dataEl = $$('streaming-data');
    if (dataEl) {
        try {
            streamingVideos = JSON.parse(dataEl.textContent);
        } catch (e) {}
    }
}

/* Handle resize */
window.addEventListener('resize', function() {
    isMobile = window.innerWidth <= 767;
});

/* Initialize */
loadStreamingData();

/* ============================================
   RELATED VIDEOS CLIENT-SIDE NAVIGATION
============================================ */
// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Related video cards - exclude current video
    var videoCards = document.querySelectorAll('.vid-card:not(.current-video)');
    videoCards.forEach(function(card) {
        var link = card.querySelector('a');
        if (link) {
            var href = link.getAttribute('href');
            var matches = href.match(/\/video\/([^\/]+)/);
            if (matches && matches[1]) {
                var videoId = matches[1];
                
                card.setAttribute('data-video-id', videoId);
                
                var parent = link.parentNode;
                while (link.firstChild) {
                    parent.insertBefore(link.firstChild, link);
                }
                link.remove();
                
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var id = this.getAttribute('data-video-id');
                    if (id) {
                        loadVideo(id);
                    }
                });
                
                card.style.cursor = 'pointer';
            }
        }
    });
});

// Also add click handlers to any dynamically loaded cards
function initVideoCards() {
    var videoCards = document.querySelectorAll('.vid-card:not([data-initialized]):not(.current-video)');
    videoCards.forEach(function(card) {
        card.setAttribute('data-initialized', 'true');
        
        var link = card.querySelector('a');
        if (link) {
            var href = link.getAttribute('href');
            var matches = href.match(/\/video\/([^\/]+)/);
            if (matches && matches[1]) {
                var videoId = matches[1];
                card.setAttribute('data-video-id', videoId);
                
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var id = this.getAttribute('data-video-id');
                    if (id) {
                        loadVideo(id);
                    }
                });
                
                card.style.cursor = 'pointer';
            }
        }
    });
}

// Call it initially and after any content updates
setTimeout(initVideoCards, 500);

})();
</script>
{% endblock scripts %}